#!/bin/sh
# This script expects that the system has python-shelltoolbox, python-
# selenium, python-yaml, and juju installed:
# sudo apt-get install python-shelltoolbox python-selenium python-yaml juju
# Deploy the charm, using a branch if given.
python lib/deploy_charm_for_testing.py "$@"
if [ $? -ne 0 ]; then
    echo "Unable to deploy Charm"
    exit 1
fi

# Figure out the URL of the APP.
export APP_URL=http://`juju status -e juju-gui-testing | grep public-address: | cut -d: -f2 | cut -c2-`
echo "APP_URL=" ${APP_URL}
# EXIT_CODE is used to keep track of test failures. If a test fails, this
# script will exit with an error code.
EXIT_CODE=0
# Run the browser tests against the app.
for JUJU_GUI_TEST_BROWSER in 'ie' 'firefox' 'chrome'
do
    export JUJU_GUI_TEST_BROWSER
    echo Launching ${JUJU_GUI_TEST_BROWSER} tests.
    python test/test_charm_running.py -v || EXIT_CODE=1
done
# Destroy the environment, releasing the resources.
yes | juju destroy-environment -e juju-gui-testing
exit $EXIT_CODE
