#!/usr/bin/env node

/**
 * We aggregate and minimize the js sources in order to improve the load speed
 * of the application.
 *
 * We don't want to use the yui combo loader feature because we want to be able
 * to run from only static files and we want to be able to run behind a
 * firewall without access to the internet.
 *
 * The final product will provide three js files: one for the YUI dependencies,
 * one for our custom js code and one for third party js like d3.
 *
 * Known issues:
 * (1) If we set "bootstrap=false" in the GlobalConfig object, yui disables the
 *     loader object. It means it wont even try to download modules. We cannot
 *     do it because the loader also manages the "use" property which defines
 *     aliases for some of your modules ('juju-views' and 'juju-controllers').
 * (2) During development, we've noticed that some of the yui modules weren't
 *     included in the list of yui files (lang/datatype-date-format_en-US,
 *     parallel, app-transitions-native, gallery-markdown, loader-base). For
 *     some reason, the loader does not resolve the names of the files for
 *     these modules. We need to add them manually in this file.
 */

'use strict';

require('yui').YUI().use(['yui'], function(Y) {
  var merge = require('../lib/merge-files.js'),
      syspath = require('path'),
      paths,
      reqs,
      filesToLoad;

  // First we find all of the paths to our custom Javascript in the app
  // directory.  We need to tell the function to ignore the "assets" directory
  // and the debug version of the modules file. I need to use
  // "syspath.join(process.cwd(), ...)" or else I have... "Error: Cannot find
  // module './app/config.js'" from node's internal module.js file.
  paths = merge.readdir(syspath.join(process.cwd(), './app'),
    [syspath.join(process.cwd(), './app/assets'),
     syspath.join(process.cwd(), './app/modules-debug.js')]);

  // templates.js is a generated file. It is not part of the app directory.
  paths.push(syspath.join(process.cwd(), './build/juju-ui/templates.js'));

  // Get the name of all the YUI modules that our custom js files use directly.
  reqs = merge.loadRequires(paths);

  // For some reason the loader does not get these requirements.
  // (Known issue #2)
  reqs.push('lang/datatype-date-format_en-US');
  reqs.push('parallel');
  reqs.push('app-transitions-native');
  reqs.push('gallery-markdown');
  reqs.push('gallery-ellipsis');
  reqs.push('loader-base');

  // Get all of the YUI files and their dependencies
  filesToLoad = merge.getYUIFiles(reqs);

  // Merge third-party files to the filesToLoad list
  filesToLoad.js.push.apply(filesToLoad.js, [
      './app/assets/javascripts/d3.v2.min.js',
      './app/assets/javascripts/d3-components.js',
      './app/assets/javascripts/reconnecting-websocket.js',
      './app/assets/javascripts/svg-layouts.js' ]);
  
  // Merge our list of custom js files to the filesToLoad list
  filesToLoad.js.push.apply(filesToLoad.js, paths);

  // Combine YUI and our js files
  merge.combine(filesToLoad.js,
      './build/juju-ui/assets/app.js', 'uglifyjs');

  // Combine third party css files
  merge.combine([ './app/assets/stylesheets/bootstrap-2.0.4.css',
      './app/assets/stylesheets/bootstrap-responsive-2.0.4.css' ],
      './build/juju-ui/assets/stylesheets/all-static.css', 'yui-css');
});
